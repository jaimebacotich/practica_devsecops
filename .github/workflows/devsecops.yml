name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # 1. Checkout del código
      # =========================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================
      # 2. Setup Node.js
      # =========================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # =========================
      # 3. Crear archivos .env necesarios
      # =========================
      - name: Create .env files for Docker Compose
        run: |
          touch frontend/.env
          touch backend/users-service/.env
          touch backend/academic-service/.env
          touch backend/api-gateway/.env

      # =========================
      # 4. Install, Lint & Test – por servicio
      # =========================
      - name: Install & Test users-service
        run: |
          cd backend/users-service
          npm ci
          npm run lint
          npm test

      - name: Install & Test academic-service
        run: |
          cd backend/academic-service
          npm ci
          npm run lint
          npm test

      - name: Install & Test api-gateway
        run: |
          cd backend/api-gateway
          npm ci
          npm run lint
          npm test

      - name: Install & Test frontend
        run: |
          cd frontend
          npm ci
          npm run lint
          npm test

      # =========================
      # 5. Instalar Semgrep (SAST)
      # =========================
      - name: Install Semgrep
        run: pip install semgrep

      # =========================
      # 6. SAST – por servicio
      # =========================
      - name: SAST user-service
        run: |
          semgrep --config=p/javascript --config=p/nodejsscan \
            backend/users-service --error --quiet

      - name: SAST academic-service
        run: |
          semgrep --config=p/javascript --config=p/nodejsscan \
            backend/academic-service --error --quiet

      - name: SAST api-gateway
        run: |
          semgrep --config=p/javascript --config=p/nodejsscan \
            backend/api-gateway --error --quiet

      # =========================
      # 7. Validar archivos .env
      #    Asegura que no contengan secretos reales
      # =========================
      - name: Validate env files
        run: |
          echo "Validando que los archivos .env no contengan secretos reales..."
          EXIT_CODE=0
          for f in \
            frontend/.env \
            backend/users-service/.env \
            backend/academic-service/.env \
            backend/api-gateway/.env; do
            if [ -s "$f" ]; then
              echo "ADVERTENCIA: $f no está vacío, revisando secretos..."
              if grep -qiE "(password|secret|key|token)\s*=\s*.+" "$f"; then
                echo "ERROR: $f parece contener secretos reales."
                EXIT_CODE=1
              else
                echo "OK: $f no contiene secretos detectables."
              fi
            else
              echo "OK: $f está vacío (sin secretos)."
            fi
          done
          exit $EXIT_CODE

      # =========================
      # 8. Build de imágenes Docker
      # =========================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          docker build -t users-service:latest ./backend/users-service
          docker build -t academic-service:latest ./backend/academic-service
          docker build -t api-gateway:latest ./backend/api-gateway

      # =========================
      # 9. Escaneo de seguridad – imágenes Docker (Trivy)
      # =========================
      - name: Trivy scan users-service
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'users-service:latest'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Trivy scan academic-service
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'academic-service:latest'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Trivy scan api-gateway
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'api-gateway:latest'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      # =========================
      # 10. Smoke Test del sistema
      # =========================
      - name: Run docker-compose
        run: |
          docker compose -f backend/docker-compose.yml up -d
          echo "Esperando que los servicios arranquen..."
          sleep 20
        continue-on-error: true

      - name: Smoke test API Gateway
        run: |
          curl -f http://localhost:3000/health || \
            (docker compose -f backend/docker-compose.yml logs && exit 1)
        continue-on-error: true

      - name: Shutdown services
        if: always()
        run: docker compose -f backend/docker-compose.yml down