name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # 1. Checkout del código
      # =========================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================
      # 2. Setup Node.js
      # =========================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # =========================
      # 3. Crear archivos .env necesarios
      # =========================
      - name: Create .env files
        run: |
          touch frontend/.env
          touch backend/users-service/.env
          touch backend/academic-service/.env
          touch backend/api-gateway/.env

      # =========================
      # 4. Instalación reproducible (npm ci)
      # =========================
      - name: Install dependencies (Reproducible)
        run: |
          echo "Installing frontend..."
          (cd frontend && npm ci)
          echo "Installing users-service..."
          (cd backend/users-service && npm ci)
          echo "Installing academic-service..."
          (cd backend/academic-service && npm ci)
          echo "Installing api-gateway..."
          (cd backend/api-gateway && npm ci)

      # =========================
      # 5. Análisis de Calidad del Código (ESLint)
      # =========================
      - name: Run Code Quality Analysis (ESLint)
        run: |
          echo "Linting frontend..."
          (cd frontend && npm run lint)
          echo "Linting users-service..."
          (cd backend/users-service && npm run lint)
          echo "Linting academic-service..."
          (cd backend/academic-service && npm run lint)
          echo "Linting api-gateway..."
          (cd backend/api-gateway && npm run lint)

      # =========================
      # 6. Testing Automático (Jest)
      # =========================
      - name: Run Automated Tests
        run: |
          echo "Testing frontend..."
          (cd frontend && npm test)
          echo "Testing users-service..."
          (cd backend/users-service && npm test)
          echo "Testing academic-service..."
          (cd backend/academic-service && npm test)
          echo "Testing api-gateway..."
          (cd backend/api-gateway && npm test)

      # =========================
      # 7. Seguridad del Código – SAST (Semgrep)
      # =========================
      - name: SAST Security Scan (Semgrep)
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/javascript
            p/nodejsscan

      # =========================
      # 8. Seguridad de Dependencias – SCA (Trivy fs)
      #    Escanea el filesystem por vulnerabilidades en paquetes
      # =========================
      - name: Dependency Security Scan - SCA (Trivy fs)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          scanners: 'vuln'

      # =========================
      # 9. Build de imágenes Docker
      # =========================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          docker build -t users-service:latest ./backend/users-service
          docker build -t academic-service:latest ./backend/academic-service
          docker build -t api-gateway:latest ./backend/api-gateway

      # =========================
      # 10. Seguridad de Contenedores (Trivy Image Scan)
      #     Solo escanea las imágenes Docker resultantes del build
      # =========================
      - name: Security Scan - users-service image (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'users-service:latest'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Security Scan - academic-service image (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'academic-service:latest'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Security Scan - api-gateway image (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'api-gateway:latest'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      # =========================
      # 11. Smoke Test del sistema
      # =========================
      - name: Run services and Smoke Test
        run: |
          docker compose -f backend/docker-compose.yml up -d
          echo "Waiting for services to start..."
          sleep 20
          curl -f http://localhost:3000/health || (docker compose -f backend/docker-compose.yml logs && exit 1)
        continue-on-error: true

      - name: Shutdown services
        if: always()
        run: docker compose -f backend/docker-compose.yml down